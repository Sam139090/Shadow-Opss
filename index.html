<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Spy Party</title>
  <style>
    /*
      Spy Party Game
      ----------------
      This single‑file web application implements a browser based party game inspired
      by the classic “Spyfall/Spy Party” genre. The design language emulates
      Apple’s Liquid Glass aesthetic using modern CSS features such as
      backdrop-filter, blur, saturation and dynamic shadows. Everything is kept
      self‑contained: no external libraries, fonts or images. All interactive
      components are pure HTML/CSS/JS.

      Features implemented include:
      • Glassmorphic theme with configurable primary/secondary colours
      • Responsive layout for desktop and mobile
      • Multilingual support (English and Persian) with dynamic RTL/LTR switch
      • Persistent settings stored in localStorage
      • Setup page allowing players/rounds/difficulty selection
      • Cryptographically secure word selection with memory of used words
      • Role reveal with 3D card flip animation
      • Countdown timer with progress ring and warning cues
      • Simple voting mechanic to decide winners

      Given the complexity of a full production game, some details (such as
      thousands of words per difficulty) are represented by small sample lists.
      Expanding the word bank is a matter of adding more strings to the arrays
      defined in `wordBank` below. The architecture is modular and organised
      around state‑driven view rendering.
    */

    /* Root variables for colours and typography */
    :root {
      --primary: #d8e3e7;
      --secondary: #8ec5fc;
      --text-color: #0a0a0a;
      --bg-blur: 40px;
      --card-blur: 25px;
      --float-blur: 15px;
      --shadow-color: rgba(0, 0, 0, 0.15);
      --shadow-strong: rgba(0,0,0,0.22);
      --glass-border: rgba(255,255,255,0.35);
      --glass-fill: rgba(255,255,255,0.22);
      --glass-fill-2: rgba(255,255,255,0.14);
      --ui-ease: cubic-bezier(0.25, 0.1, 0.25, 1);
      --spring-ease: cubic-bezier(0.34, 1.56, 0.64, 1);
      --fade-ease: ease-in-out;
      --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen,
        Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
    }

    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      background: var(--primary);
      font-family: var(--font-family);
      color: var(--text-color);
    }

    body {
      display: flex;
      justify-content: center;
      align-items: center;
      position: relative;
    }

    /* Background blur layer */
    #bg {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background:
        radial-gradient(1200px 800px at 20% 20%, color-mix(in srgb, var(--secondary) 50%, white 50%) 0%, transparent 60%),
        radial-gradient(900px 700px at 80% 30%, color-mix(in srgb, var(--primary) 55%, white 45%) 0%, transparent 55%),
        radial-gradient(900px 900px at 50% 90%, color-mix(in srgb, var(--secondary) 35%, white 65%) 0%, transparent 60%),
        linear-gradient(135deg, rgba(255,255,255,0.5), rgba(255,255,255,0.08));
      backdrop-filter: blur(var(--bg-blur)) saturate(180%);
      z-index: -3;
    }

    /* Animated floating glass blobs (transform-only) */
    .blob {
      position: absolute;
      width: 420px;
      height: 420px;
      border-radius: 50%;
      opacity: 0.55;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.85), rgba(255,255,255,0.1) 55%, transparent 65%);
      mix-blend-mode: overlay;
      transform: translate3d(0,0,0);
      will-change: transform;
      pointer-events: none;
      z-index: -2;
      animation: floaty 10s var(--fade-ease) infinite alternate;
    }
    .blob.b2 { width: 520px; height: 520px; opacity: 0.42; animation-duration: 13s; }
    .blob.b3 { width: 360px; height: 360px; opacity: 0.48; animation-duration: 11s; }
    @keyframes floaty {
      from { transform: translate3d(-10px, -8px, 0) scale(1); }
      to   { transform: translate3d(12px, 10px, 0) scale(1.03); }
    }

    /* Container for pages */
    #app {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      position: relative;
    }

    /* Common glass card */
    .glass {
      background: linear-gradient(180deg, var(--glass-fill), var(--glass-fill-2));
      box-shadow:
        0 22px 45px rgba(0,0,0,0.12),
        0 4px 16px rgba(0,0,0,0.10);
      backdrop-filter: blur(var(--card-blur)) saturate(180%);
      border: 1px solid var(--glass-border);
      border-radius: 20px;
      position: relative;
      overflow: hidden;
    }
    .glass::before {
      content: "";
      position: absolute;
      inset: -2px;
      background:
        radial-gradient(600px 180px at 20% 10%, rgba(255,255,255,0.40), transparent 60%),
        radial-gradient(500px 240px at 80% 0%, rgba(255,255,255,0.25), transparent 65%);
      pointer-events: none;
      mix-blend-mode: screen;
    }

    .hidden {
      display: none;
    }

    /* Button styling */
    button {
      cursor: pointer;
      border: none;
      outline: none;
      padding: 12px 24px;
      margin: 8px;
      font-size: 1rem;
      border-radius: 12px;
      position: relative;
      background: linear-gradient(145deg,
        color-mix(in srgb, var(--primary) 70%, white 30%),
        color-mix(in srgb, var(--secondary) 55%, white 45%));
      color: rgba(0,0,0,0.9);
      box-shadow: 0 18px 30px rgba(0,0,0,0.14);
      transition: transform 180ms var(--ui-ease), filter 250ms var(--fade-ease), box-shadow 250ms var(--fade-ease);
      will-change: transform;
    }

    button:hover { transform: scale(1.05); filter: saturate(1.06); }
    button:active { transform: scale(0.96); }

    button::after {
      content: "";
      position: absolute;
      inset: 0;
      border-radius: inherit;
      background: radial-gradient(220px 80px at 20% 15%, rgba(255,255,255,0.55), transparent 60%);
      opacity: 0.55;
      pointer-events: none;
      transition: opacity 250ms var(--fade-ease);
    }
    button:hover::after { opacity: 0.75; }

    /* Icon button (gear) */
    .icon-btn {
      position: absolute;
      top: 18px;
      right: 18px;
      width: 44px;
      height: 44px;
      border-radius: 14px;
      padding: 0;
      margin: 0;
      display: grid;
      place-items: center;
      background: linear-gradient(180deg, rgba(255,255,255,0.38), rgba(255,255,255,0.16));
      border: 1px solid rgba(255,255,255,0.35);
      box-shadow: 0 20px 35px rgba(0,0,0,0.14);
      backdrop-filter: blur(var(--float-blur)) saturate(180%);
      z-index: 50;
    }
    .icon-btn svg {
      width: 20px;
      height: 20px;
      opacity: 0.9;
      transform: translateZ(0);
      will-change: transform;
      transition: transform 220ms var(--spring-ease);
    }
    .icon-btn:hover svg { transform: scale(1.08); }

    /* Pages styles */
    .page {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      padding: 20px;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      transition: transform 350ms var(--ui-ease), opacity 350ms var(--fade-ease);
      opacity: 0;
      transform: translateX(100%);
    }
    .page.active {
      opacity: 1;
      transform: translateX(0);
    }

    /* Header style */
    h1, h2, h3, p {
      margin: 0.5em 0;
      text-align: center;
    }
    h1 { font-size: clamp(2rem, 3vw, 2.6rem); letter-spacing: -0.02em; }
    h2 { font-size: clamp(1.4rem, 2.4vw, 1.9rem); letter-spacing: -0.015em; }
    p { opacity: 0.85; line-height: 1.5; max-width: 720px; }

    /* Main menu */
    #main-menu .buttons {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    /* Guide page style */
    #guide-content {
      max-width: 600px;
      background: rgba(255,255,255,0.15);
      padding: 20px;
      border-radius: 20px;
      border: 1px solid rgba(255,255,255,0.3);
      box-shadow: 0 4px 30px var(--shadow-color);
      backdrop-filter: blur(var(--card-blur)) saturate(180%);
      overflow-y: auto;
      max-height: 70vh;
    }

    /* Settings list */
    #settings-options {
      display: flex;
      flex-direction: column;
      width: 100%;
      max-width: 600px;
    }
    .setting-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin: 10px 0;
    }
    .setting-row label {
      flex: 1;
    }
    .setting-row input[type=color] {
      width: 48px;
      height: 32px;
      border: none;
      border-radius: 8px;
      padding: 0;
    }
    .toggle {
      position: relative;
      width: 50px;
      height: 28px;
      border-radius: 14px;
      background: rgba(255,255,255,0.4);
      backdrop-filter: blur(var(--card-blur));
      cursor: pointer;
      transition: background 250ms;
    }
    .toggle::after {
      content: '';
      position: absolute;
      top: 4px;
      left: 4px;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: white;
      box-shadow: 0 2px 4px var(--shadow-color);
      transition: transform 250ms;
    }
    .toggle.on {
      background: var(--secondary);
    }
    .toggle.on::after {
      transform: translateX(22px);
    }

    /* Setup form styling */
    #setup-form {
      display: flex;
      flex-direction: column;
      max-width: 400px;
      width: 100%;
    }
    #setup-form label { margin: 0; }
    #setup-form .field {
      margin-top: 14px;
      padding: 14px 14px 12px;
    }
    #setup-form .field.glass { border-radius: 18px; }
    .field-head {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 10px;
    }
    .field-head .value {
      font-variant-numeric: tabular-nums;
      opacity: 0.85;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,0.18);
      border: 1px solid rgba(255,255,255,0.28);
      backdrop-filter: blur(var(--float-blur));
    }

    #setup-form select {
      width: 100%;
      margin-top: 12px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.25);
      background: rgba(255,255,255,0.18);
      backdrop-filter: blur(var(--float-blur)) saturate(180%);
      outline: none;
    }

    input[type=range] {
      width: 100%;
      margin-top: 12px;
      -webkit-appearance: none;
      appearance: none;
      background: transparent;
      height: 26px;
      cursor: pointer;
    }
    input[type=range]::-webkit-slider-runnable-track {
      height: 8px;
      border-radius: 999px;
      background: linear-gradient(90deg,
        color-mix(in srgb, var(--secondary) 70%, white 30%),
        rgba(255,255,255,0.25));
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.25);
    }
    input[type=range]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 18px;
      height: 18px;
      margin-top: -5px;
      border-radius: 50%;
      background: linear-gradient(180deg, rgba(255,255,255,0.92), rgba(255,255,255,0.55));
      border: 1px solid rgba(255,255,255,0.45);
      box-shadow: 0 10px 18px rgba(0,0,0,0.18);
    }
    input[type=range]::-moz-range-track {
      height: 8px;
      border-radius: 999px;
      background: linear-gradient(90deg,
        color-mix(in srgb, var(--secondary) 70%, white 30%),
        rgba(255,255,255,0.25));
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.25);
    }
    input[type=range]::-moz-range-thumb {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: linear-gradient(180deg, rgba(255,255,255,0.92), rgba(255,255,255,0.55));
      border: 1px solid rgba(255,255,255,0.45);
      box-shadow: 0 10px 18px rgba(0,0,0,0.18);
    }

    /* Role reveal card */
    #role-card {
      width: 240px;
      height: 320px;
      perspective: 1200px;
      margin: 20px auto;
    }
    .card-inner {
      position: relative;
      width: 100%;
      height: 100%;
      transform-style: preserve-3d;
      transition: transform 600ms cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    .card.flipped .card-inner {
      transform: rotateY(180deg);
    }
    .card-face {
      position: absolute;
      width: 100%;
      height: 100%;
      backface-visibility: hidden;
      display: flex;
      justify-content: center;
      align-items: center;
      border-radius: 16px;
      background: linear-gradient(180deg,
        rgba(255,255,255,0.32),
        rgba(255,255,255,0.14));
      backdrop-filter: blur(var(--card-blur)) saturate(200%);
      border: 1px solid rgba(255,255,255,0.35);
      box-shadow:
        0 26px 70px rgba(0,0,0,0.18),
        inset 0 1px 0 rgba(255,255,255,0.25);
      font-size: 1.3rem;
      text-align: center;
      padding: 20px;
      overflow: hidden;
    }
    .card-face::before {
      content: "";
      position: absolute;
      inset: -2px;
      background:
        radial-gradient(260px 160px at 25% 15%, rgba(255,255,255,0.45), transparent 60%),
        radial-gradient(220px 180px at 80% 85%, rgba(255,255,255,0.22), transparent 60%),
        linear-gradient(120deg, rgba(255,255,255,0.08), rgba(255,255,255,0));
      pointer-events: none;
      mix-blend-mode: screen;
    }
    .card-front { font-weight: 600; }
    .card-back {
      transform: rotateY(180deg);
      font-weight: 700;
      letter-spacing: -0.01em;
    }
    .role-pill {
      display: inline-block;
      padding: 8px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,0.18);
      border: 1px solid rgba(255,255,255,0.30);
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.25);
      backdrop-filter: blur(var(--float-blur));
      margin-bottom: 10px;
      opacity: 0.92;
    }
    .spy-theme .card-back {
      background:
        radial-gradient(500px 220px at 50% 30%, rgba(255,0,80,0.18), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,0.32), rgba(255,255,255,0.12));
    }
    .citizen-theme .card-back {
      background:
        radial-gradient(500px 220px at 50% 30%, rgba(20,210,170,0.16), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,0.32), rgba(255,255,255,0.12));
    }

    /* Spy shake effect */
    @keyframes spyshake {
      0%   { transform: translate3d(0,0,0) rotate(0deg); }
      15%  { transform: translate3d(-3px, 1px, 0) rotate(-1deg); }
      30%  { transform: translate3d(4px, -1px, 0) rotate(1deg); }
      45%  { transform: translate3d(-4px, 0px, 0) rotate(-1deg); }
      60%  { transform: translate3d(3px, 1px, 0) rotate(1deg); }
      75%  { transform: translate3d(-2px, -1px, 0) rotate(-0.5deg); }
      100% { transform: translate3d(0,0,0) rotate(0deg); }
    }
    .spy-shake { animation: spyshake 600ms var(--spring-ease) 1; }

    /* Timer styles */
    #timer-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-top: 20px;
    }
    #timer-svg {
      width: 180px;
      height: 180px;
      transform: rotate(-90deg);
    }
    #vote-button {
      margin-top: 20px;
      opacity: 0;
      transform: translateY(20px);
      transition: opacity 350ms ease-in-out, transform 350ms ease-in-out;
    }
    #vote-button.show {
      opacity: 1;
      transform: translateY(0);
    }

    /* Player voting list */
    #vote-list {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      margin-top: 20px;
      width: 100%;
    }
    .vote-card {
      margin: 8px;
      padding: 12px 20px;
      border-radius: 12px;
      backdrop-filter: blur(var(--float-blur)) saturate(180%);
      background: rgba(255,255,255,0.2);
      box-shadow: 0 4px 10px var(--shadow-color);
      cursor: pointer;
      transition: transform 200ms, background 200ms;
    }
    .vote-card.selected {
      background: var(--secondary);
      transform: scale(1.05);
    }

    /* Responsive adjustments */
    @media (max-width: 600px) {
      #setup-form {
        max-width: 90vw;
      }
    }

    @media (prefers-reduced-motion: reduce) {
      * { animation-duration: 0.001ms !important; animation-iteration-count: 1 !important; transition-duration: 0.001ms !important; }
    }
  </style>
</head>
<body>
  <div id="bg"></div>
  <div class="blob" style="left:-140px; top:-120px"></div>
  <div class="blob b2" style="right:-200px; top:40px"></div>
  <div class="blob b3" style="left:40px; bottom:-180px"></div>
  <div id="app">
    <!-- Global gear button (top-right) -->
    <button id="gear-btn" class="icon-btn" aria-label="Settings">
      <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <path d="M12 15.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7Z" stroke="rgba(0,0,0,0.85)" stroke-width="1.8" stroke-linecap="round"/>
        <path d="M19.4 15a8.8 8.8 0 0 0 .1-1l1.7-1.3-1.7-2.9-2.1.5a8.7 8.7 0 0 0-1.6-.9L15.5 7 12 5.7 8.5 7l-.3 2.4a8.7 8.7 0 0 0-1.6.9l-2.1-.5-1.7 2.9L4.5 14a8.8 8.8 0 0 0 .1 1l-1.8 1.4 1.7 2.9 2.2-.5c.5.4 1 .7 1.6.9l.3 2.4 3.5 1.3 3.5-1.3.3-2.4c.6-.2 1.1-.5 1.6-.9l2.2.5 1.7-2.9L19.4 15Z" stroke="rgba(0,0,0,0.75)" stroke-width="1.6" stroke-linejoin="round"/>
      </svg>
    </button>
    <!-- Main Menu Page -->
    <div id="main-menu" class="page active">
      <h1 id="title">Spy Party</h1>
      <div class="buttons">
        <button id="continue-btn"></button>
        <button id="guide-btn"></button>
        <button id="settings-btn"></button>
      </div>
    </div>

    <!-- Guide Page -->
    <div id="guide-page" class="page">
      <h2 id="guide-title"></h2>
      <div id="guide-content" class="glass">
        <p id="guide-text"></p>
      </div>
      <button id="back-from-guide"></button>
    </div>

    <!-- Settings Page -->
    <div id="settings-page" class="page">
      <h2 id="settings-title"></h2>
      <div id="settings-options">
        <div class="setting-row">
          <label id="lang-label" for="language-select"></label>
          <select id="language-select">
            <option value="en">English</option>
            <option value="fa">فارسی</option>
          </select>
        </div>
        <div class="setting-row">
          <label id="primary-label" for="primary-color"></label>
          <input id="primary-color" type="color" value="#d8e3e7" />
        </div>
        <div class="setting-row">
          <label id="secondary-label" for="secondary-color"></label>
          <input id="secondary-color" type="color" value="#8ec5fc" />
        </div>
        <div class="setting-row">
          <label id="sound-label"></label>
          <div id="sound-toggle" class="toggle"></div>
        </div>
        <div class="setting-row">
          <label id="vibration-label"></label>
          <div id="vibration-toggle" class="toggle"></div>
        </div>
      </div>
      <button id="back-from-settings"></button>
    </div>

    <!-- Setup Page -->
    <div id="setup-page" class="page">
      <h2 id="setup-title"></h2>
      <form id="setup-form">
        <div class="field glass">
          <div class="field-head">
            <label id="player-count-label" for="player-count"></label>
            <span class="value" id="player-count-val"></span>
          </div>
          <input id="player-count" type="range" min="3" max="20" step="1" value="4" />
        </div>

        <div class="field glass">
          <div class="field-head">
            <label id="spy-count-label" for="spy-count"></label>
            <span class="value" id="spy-count-val"></span>
          </div>
          <input id="spy-count" type="range" min="1" max="2" step="1" value="1" />
        </div>

        <div class="field glass">
          <div class="field-head">
            <label id="round-time-label" for="round-time"></label>
            <span class="value" id="round-time-val"></span>
          </div>
          <input id="round-time" type="range" min="1" max="10" step="1" value="3" />
        </div>

        <div class="field glass">
          <div class="field-head">
            <label id="rounds-label" for="rounds"></label>
            <span class="value" id="rounds-val"></span>
          </div>
          <input id="rounds" type="range" min="1" max="10" step="1" value="3" />
        </div>

        <div class="field glass">
          <div class="field-head">
            <label id="difficulty-label" for="difficulty"></label>
          </div>
          <select id="difficulty">
            <option value="easy"></option>
            <option value="medium"></option>
            <option value="hard"></option>
            <option value="extreme"></option>
          </select>
        </div>
        <button type="button" id="start-game"></button>
      </form>
    </div>

    <!-- Role Reveal Page -->
    <div id="role-page" class="page">
      <h2 id="reveal-title"></h2>
      <div id="role-card" class="card">
        <div class="card-inner">
          <div class="card-face card-front" id="role-front">Tap to reveal</div>
          <div class="card-face card-back" id="role-back"></div>
        </div>
      </div>
      <p id="role-instructions"></p>
    </div>

    <!-- Timer & Voting Page -->
    <div id="timer-page" class="page">
      <h2 id="timer-title"></h2>
      <div id="timer-container">
        <svg id="timer-svg" viewBox="0 0 100 100">
          <circle cx="50" cy="50" r="45" fill="none" stroke="rgba(255,255,255,0.2)" stroke-width="6"/>
          <circle id="timer-ring" cx="50" cy="50" r="45" fill="none" stroke="var(--secondary)" stroke-width="6" stroke-dasharray="282.743" stroke-dashoffset="0"/>
        </svg>
      </div>
      <button id="vote-button"></button>
    </div>

    <!-- Voting Page -->
    <div id="vote-page" class="page">
      <h2 id="vote-title"></h2>
      <div id="vote-list"></div>
      <button id="show-result-btn"></button>
    </div>

    <!-- Result Page -->
    <div id="result-page" class="page">
      <h2 id="result-title"></h2>
      <p id="result-message"></p>
      <button id="back-to-menu"></button>
    </div>
  </div>

  <script>
    /* Application state and constants */
    const state = {
      language: localStorage.getItem('spyparty_language') || 'en',
      primary: localStorage.getItem('spyparty_primary') || '#d8e3e7',
      secondary: localStorage.getItem('spyparty_secondary') || '#8ec5fc',
      sound: JSON.parse(localStorage.getItem('spyparty_sound') || 'true'),
      vibration: JSON.parse(localStorage.getItem('spyparty_vibration') || 'true'),
      players: [],
      spies: [],
      wordsUsed: JSON.parse(localStorage.getItem('spyparty_words') || '{}'),
      wordBank: {
        en: {
          easy: ['apple','river','cat','market','car','star','window','music','garden','book'],
          medium: ['airport','engineer','philosophy','university','restaurant','pyramid','eclipse','mountain','artist','chocolate'],
          hard: ['cryptography','metamorphosis','subconscious','photosynthesis','architecture','microscopy','algorithm','parliament','laboratory','pendulum'],
          extreme: ['polymerization','electromagnetism','photosynthetic','microprocessor','bureaucracy','quantization','bioinformatics','conflagration','neurotransmitter','philanthropist']
        },
        fa: {
          easy: ['سیب','رود','گربه','بازار','ماشین','ستاره','پنجره','موسیقی','باغ','کتاب'],
          medium: ['فرودگاه','مهندس','فلسفه','دانشگاه','رستوران','اهرام','خورشیدگرفتگی','کوهستان','هنرمند','شکلات'],
          hard: ['رمزشناسی','دگردیسی','ناخودآگاه','فتوسنتز','معماری','میکروسکوپی','الگوریتم','مجلس','آزمایشگاه','پاندول'],
          extreme: ['پلیمرسازی','الکترومغناطیس','فوتوسنتتیک','ریزپردازنده','بوروکراسی','کوانتش','زیست‌اطلاعاتی','حریق گسترده','نوروترانسمیتر','نیکوکاری']
        }
      },
      currentRound: 0,
      maxRounds: 1,
      roundTime: 3,
      playerCount: 4,
      spyCount: 1,
      difficulty: 'easy',
      roles: [],
      currentPlayerIndex: 0,
      votes: {},
      timerInterval: null,
    };

    /* Translation dictionary */
    const i18n = {
      en: {
        title: 'Spy Party',
        continue: 'Continue',
        guide: 'Guide',
        settings: 'Settings',
        guideTitle: 'How to Play',
        guideText: 'In this party game, players are given secret roles. Most will receive a common word; one or more will be spies who receive no word. The spies must deduce the word through conversation without being discovered. Citizens must identify the spies.',
        back: 'Back',
        settingsTitle: 'Settings',
        language: 'Language',
        primaryColor: 'Primary color',
        secondaryColor: 'Secondary color',
        sound: 'Sound effects',
        vibration: 'Vibration',
        setupTitle: 'Game Setup',
        playerCount: 'Number of players',
        spyCount: 'Number of spies',
        roundTime: 'Round time (minutes)',
        rounds: 'Number of rounds',
        difficulty: 'Difficulty',
        easy: 'Easy',
        medium: 'Medium',
        hard: 'Hard',
        extreme: 'Extreme',
        start: 'Start Game',
        tapReveal: 'Tap to reveal your role',
        tapNext: 'Tap to pass to next player',
        revealTitle: 'Role Reveal',
        revealInstr: 'Each player taps to reveal their role. Pass the device to the next player.',
        youAreSpy: 'You are the Spy',
        yourWord: 'Your word:',
        timerTitle: 'Discuss',
        vote: 'Vote',
        voteTitle: 'Voting',
        voteInstructions: 'Select players you suspect of being spies and submit.',
        showResult: 'Show Result',
        resultTitle: 'Result',
        citizensWin: 'Citizens win! All spies caught.',
        spiesWin: 'Spies win! They remain hidden.',
        draw: 'It\'s a draw.',
        backToMenu: 'Back to Menu',
        noMoreWords: 'No more unused words available. Please reset words from settings.',
      },
      fa: {
        title: 'بازی جاسوس',
        continue: 'ادامه',
        guide: 'راهنما',
        settings: 'تنظیمات',
        guideTitle: 'نحوه بازی',
        guideText: 'در این بازی گروهی، بازیکنان نقش‌های مخفی دریافت می‌کنند. اکثر بازیکنان یک کلمه مشترک می‌گیرند؛ اما یک یا چند نفر جاسوس هستند و کلمه‌ای ندارند. جاسوس‌ها باید از طریق گفتگو کلمه را حدس بزنند بدون آنکه شناسایی شوند. شهروندان باید جاسوس‌ها را پیدا کنند.',
        back: 'بازگشت',
        settingsTitle: 'تنظیمات',
        language: 'زبان',
        primaryColor: 'رنگ اصلی',
        secondaryColor: 'رنگ ثانویه',
        sound: 'افکت صدا',
        vibration: 'لرزش',
        setupTitle: 'راه‌اندازی بازی',
        playerCount: 'تعداد بازیکنان',
        spyCount: 'تعداد جاسوسان',
        roundTime: 'زمان هر دور (دقیقه)',
        rounds: 'تعداد دورها',
        difficulty: 'سطح سختی',
        easy: 'آسان',
        medium: 'متوسط',
        hard: 'سخت',
        extreme: 'فوق‌العاده سخت',
        start: 'شروع بازی',
        tapReveal: 'برای دیدن نقش لمس کنید',
        tapNext: 'برای نفر بعدی لمس کنید',
        revealTitle: 'نمایش نقش',
        revealInstr: 'هر بازیکن روی کارت خود بزند تا نقشش را ببیند. سپس دستگاه را به نفر بعد بدهید.',
        youAreSpy: 'تو جاسوسی',
        yourWord: 'کلمه تو:',
        timerTitle: 'بحث کنید',
        vote: 'رأی',
        voteTitle: 'رأی‌گیری',
        voteInstructions: 'بازیکنان مظنون به جاسوسی را انتخاب کرده و ارسال کنید.',
        showResult: 'نمایش نتیجه',
        resultTitle: 'نتیجه',
        citizensWin: 'شهروندان پیروز شدند! همه جاسوس‌ها شناسایی شدند.',
        spiesWin: 'جاسوسان پیروز شدند! آن‌ها مخفی ماندند.',
        draw: 'بازی مساوی شد.',
        backToMenu: 'بازگشت به منو',
        noMoreWords: 'هیچ کلمه استفاده‌نشده‌ای باقی نمانده است. لطفاً کلمات را از تنظیمات بازنشانی کنید.',
      }
    };

    /* Utility functions */
    function updateTheme() {
      document.documentElement.style.setProperty('--primary', state.primary);
      document.documentElement.style.setProperty('--secondary', state.secondary);
    }

    function updateLanguage() {
      const dict = i18n[state.language];
      // Update static texts
      document.getElementById('title').textContent = dict.title;
      document.getElementById('continue-btn').textContent = dict.continue;
      document.getElementById('guide-btn').textContent = dict.guide;
      document.getElementById('settings-btn').textContent = dict.settings;
      document.getElementById('guide-title').textContent = dict.guideTitle;
      document.getElementById('guide-text').textContent = dict.guideText;
      document.getElementById('back-from-guide').textContent = dict.back;
      document.getElementById('settings-title').textContent = dict.settingsTitle;
      document.getElementById('lang-label').textContent = dict.language;
      document.getElementById('primary-label').textContent = dict.primaryColor;
      document.getElementById('secondary-label').textContent = dict.secondaryColor;
      document.getElementById('sound-label').textContent = dict.sound;
      document.getElementById('vibration-label').textContent = dict.vibration;
      document.getElementById('back-from-settings').textContent = dict.back;
      document.getElementById('setup-title').textContent = dict.setupTitle;
      document.getElementById('player-count-label').textContent = dict.playerCount;
      document.getElementById('spy-count-label').textContent = dict.spyCount;
      document.getElementById('round-time-label').textContent = dict.roundTime;
      document.getElementById('rounds-label').textContent = dict.rounds;
      document.getElementById('difficulty-label').textContent = dict.difficulty;
      document.getElementById('difficulty').options[0].textContent = dict.easy;
      document.getElementById('difficulty').options[1].textContent = dict.medium;
      document.getElementById('difficulty').options[2].textContent = dict.hard;
      document.getElementById('difficulty').options[3].textContent = dict.extreme;
      document.getElementById('start-game').textContent = dict.start;
      document.getElementById('reveal-title').textContent = dict.revealTitle;
      document.getElementById('role-front').textContent = dict.tapReveal;
      document.getElementById('role-instructions').textContent = dict.revealInstr;
      document.getElementById('timer-title').textContent = dict.timerTitle;
      document.getElementById('vote-button').textContent = dict.vote;
      document.getElementById('vote-title').textContent = dict.voteTitle;
      document.getElementById('show-result-btn').textContent = dict.showResult;
      document.getElementById('result-title').textContent = dict.resultTitle;
      document.getElementById('back-to-menu').textContent = dict.backToMenu;

      // Set direction and text alignment based on language
      document.documentElement.setAttribute('dir', state.language === 'fa' ? 'rtl' : 'ltr');
      // LTR/RTL friendly transform origins
      document.querySelectorAll('.page').forEach(p => {
        p.style.transformOrigin = (state.language === 'fa') ? 'right center' : 'left center';
      });
      // apply text alignment to dynamic elements if needed
    }

    // --- Sound (Web Audio, fully self-contained) ---
    const SFX = (() => {
      let ctx = null;
      let master = null;
      let unlocked = false;
      function ensure() {
        if (!state.sound) return null;
        if (!ctx) {
          const AC = window.AudioContext || window.webkitAudioContext;
          ctx = new AC();
          master = ctx.createGain();
          master.gain.value = 0.35;
          master.connect(ctx.destination);
        }
        return ctx;
      }
      async function unlock() {
        if (unlocked) return;
        const c = ensure();
        if (!c) return;
        if (c.state === 'suspended') {
          try { await c.resume(); } catch (_) {}
        }
        // tiny silent blip to unlock on iOS
        const o = c.createOscillator();
        const g = c.createGain();
        g.gain.value = 0.0001;
        o.frequency.value = 440;
        o.connect(g); g.connect(master);
        o.start(); o.stop(c.currentTime + 0.01);
        unlocked = true;
      }

      function glassPing({ freq = 880, dur = 0.12, gain = 0.20, detune = 6 } = {}) {
        const c = ensure();
        if (!c) return;
        const t0 = c.currentTime;
        const o1 = c.createOscillator();
        const o2 = c.createOscillator();
        const g = c.createGain();
        const bp = c.createBiquadFilter();
        bp.type = 'bandpass';
        bp.frequency.setValueAtTime(freq, t0);
        bp.Q.setValueAtTime(8, t0);
        o1.type = 'sine';
        o2.type = 'triangle';
        o1.frequency.setValueAtTime(freq, t0);
        o2.frequency.setValueAtTime(freq * 1.01, t0);
        o1.detune.setValueAtTime(-detune, t0);
        o2.detune.setValueAtTime(detune, t0);
        g.gain.setValueAtTime(0.0001, t0);
        g.gain.exponentialRampToValueAtTime(gain, t0 + 0.01);
        g.gain.exponentialRampToValueAtTime(0.0001, t0 + dur);
        o1.connect(bp); o2.connect(bp);
        bp.connect(g);
        g.connect(master);
        o1.start(t0);
        o2.start(t0);
        o1.stop(t0 + dur + 0.02);
        o2.stop(t0 + dur + 0.02);
      }

      function click() { glassPing({ freq: 1040, gain: 0.18, dur: 0.10 }); }
      function flip() { glassPing({ freq: 740, gain: 0.22, dur: 0.14 }); }
      function warn() { glassPing({ freq: 520, gain: 0.24, dur: 0.12 }); }
      function tick() { glassPing({ freq: 680, gain: 0.14, dur: 0.07 }); }

      return { ensure, unlock, click, flip, warn, tick };
    })();

    function saveSettings() {
      localStorage.setItem('spyparty_language', state.language);
      localStorage.setItem('spyparty_primary', state.primary);
      localStorage.setItem('spyparty_secondary', state.secondary);
      localStorage.setItem('spyparty_sound', state.sound);
      localStorage.setItem('spyparty_vibration', state.vibration);
      localStorage.setItem('spyparty_words', JSON.stringify(state.wordsUsed));
    }

    function showPage(id) {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.getElementById(id).classList.add('active');
    }

    function rangeRandom(max) {
      // secure random integer [0, max)
      const array = new Uint32Array(1);
      window.crypto.getRandomValues(array);
      return array[0] % max;
    }

    function pickWord() {
      const lang = state.language;
      const diff = state.difficulty;
      const bank = state.wordBank[lang][diff];
      if (!state.wordsUsed[lang]) state.wordsUsed[lang] = {};
      if (!state.wordsUsed[lang][diff]) state.wordsUsed[lang][diff] = [];
      const used = new Set(state.wordsUsed[lang][diff]);
      const available = bank.filter(w => !used.has(w));
      if (available.length === 0) {
        alert(i18n[state.language].noMoreWords);
        return null;
      }
      const idx = rangeRandom(available.length);
      const word = available[idx];
      state.wordsUsed[lang][diff].push(word);
      saveSettings();
      return word;
    }

    /* Role assignment */
    function assignRoles() {
      state.roles = [];
      const word = pickWord();
      if (!word) return;
      // push spies as false for citizens, true for spy
      const arr = Array(state.playerCount).fill(false);
      let spiesAssigned = 0;
      while (spiesAssigned < state.spyCount) {
        const idx = rangeRandom(state.playerCount);
        if (!arr[idx]) {
          arr[idx] = true;
          spiesAssigned++;
        }
      }
      state.roles = arr.map(isSpy => ({ isSpy, word: isSpy ? null : word }));
    }

    // --- Setup sliders + constraints ---
    const setupUI = {
      pc: null, sc: null, rt: null, rd: null,
      pcV: null, scV: null, rtV: null, rdV: null,
    };

    function maxSpiesForPlayers(playerCount) {
      // do not allow spies > citizens
      return Math.max(1, Math.floor(playerCount / 2));
    }

    function syncSetupUI() {
      const pc = parseInt(setupUI.pc.value);
      const maxSpies = maxSpiesForPlayers(pc);
      setupUI.sc.max = String(maxSpies);
      if (parseInt(setupUI.sc.value) > maxSpies) setupUI.sc.value = String(maxSpies);

      setupUI.pcV.textContent = String(pc);
      setupUI.scV.textContent = String(setupUI.sc.value);
      setupUI.rtV.textContent = String(setupUI.rt.value) + (state.language === 'fa' ? ' دقیقه' : ' min');
      setupUI.rdV.textContent = String(setupUI.rd.value);
    }

    /* Event Handlers */
    function initEventHandlers() {
      // unlock audio on first user gesture
      window.addEventListener('pointerdown', () => SFX.unlock(), { once: true, passive: true });

      // global gear button
      document.getElementById('gear-btn').addEventListener('click', () => {
        openSettings();
      });

      // Main menu buttons
      document.getElementById('continue-btn').addEventListener('click', () => {
        SFX.click();
        showPage('setup-page');
      });
      document.getElementById('guide-btn').addEventListener('click', () => {
        SFX.click();
        showPage('guide-page');
      });
      document.getElementById('settings-btn').addEventListener('click', () => {
        SFX.click();
        openSettings();
      });
      // Back buttons
      document.getElementById('back-from-guide').addEventListener('click', () => showPage('main-menu'));
      document.getElementById('back-from-settings').addEventListener('click', () => showPage('main-menu'));
      // Settings interactions
      document.getElementById('language-select').addEventListener('change', e => {
        state.language = e.target.value;
        updateLanguage();
        syncSetupUI();
        saveSettings();
      });
      document.getElementById('primary-color').addEventListener('input', e => {
        state.primary = e.target.value;
        updateTheme();
        saveSettings();
      });
      document.getElementById('secondary-color').addEventListener('input', e => {
        state.secondary = e.target.value;
        updateTheme();
        saveSettings();
      });
      // Toggle controls
      document.getElementById('sound-toggle').addEventListener('click', e => {
        state.sound = !state.sound;
        e.currentTarget.classList.toggle('on', state.sound);
        SFX.click();
        saveSettings();
      });
      document.getElementById('vibration-toggle').addEventListener('click', e => {
        state.vibration = !state.vibration;
        e.currentTarget.classList.toggle('on', state.vibration);
        SFX.click();
        saveSettings();
      });

      // Setup sliders
      setupUI.pc = document.getElementById('player-count');
      setupUI.sc = document.getElementById('spy-count');
      setupUI.rt = document.getElementById('round-time');
      setupUI.rd = document.getElementById('rounds');
      setupUI.pcV = document.getElementById('player-count-val');
      setupUI.scV = document.getElementById('spy-count-val');
      setupUI.rtV = document.getElementById('round-time-val');
      setupUI.rdV = document.getElementById('rounds-val');

      const onSlide = () => { syncSetupUI(); };
      setupUI.pc.addEventListener('input', onSlide, { passive: true });
      setupUI.sc.addEventListener('input', onSlide, { passive: true });
      setupUI.rt.addEventListener('input', onSlide, { passive: true });
      setupUI.rd.addEventListener('input', onSlide, { passive: true });
      // Setup form
      document.getElementById('start-game').addEventListener('click', () => {
        SFX.click();
        state.playerCount = parseInt(setupUI.pc.value);
        state.spyCount = parseInt(setupUI.sc.value);
        state.roundTime = parseInt(setupUI.rt.value);
        state.maxRounds = parseInt(setupUI.rd.value);
        state.difficulty = document.getElementById('difficulty').value;
        state.currentRound = 1;
        assignRoles();
        state.currentPlayerIndex = 0;
        showPage('role-page');
        updateRoleView();
      });
      // Role reveal card handler
      document.getElementById('role-card').addEventListener('click', () => {
        const card = document.getElementById('role-card');
        if (!card.classList.contains('flipped')) {
          SFX.flip();
          card.classList.add('flipped');
          // Set content based on role
          const role = state.roles[state.currentPlayerIndex];
          const back = document.getElementById('role-back');
          if (role.isSpy) {
            card.classList.remove('citizen-theme');
            card.classList.add('spy-theme');
            back.innerHTML = '<div><div class="role-pill">' + i18n[state.language].youAreSpy + '</div><div style="opacity:.82">' + (state.language === 'fa' ? 'هیچ کلمه‌ای نداری.' : 'You have no word.') + '</div></div>';
            card.classList.remove('spy-shake');
            // restart shake
            void card.offsetWidth;
            card.classList.add('spy-shake');
          } else {
            card.classList.remove('spy-theme');
            card.classList.add('citizen-theme');
            back.innerHTML = '<div><div class="role-pill">' + i18n[state.language].yourWord + '</div><div style="font-size:1.65rem; letter-spacing:-0.02em">' + role.word + '</div></div>';
          }
          document.getElementById('role-front').textContent = i18n[state.language].tapNext;
        } else {
          SFX.click();
          // Next player or start timer
          card.classList.remove('flipped');
          state.currentPlayerIndex++;
          if (state.currentPlayerIndex >= state.playerCount) {
            startTimer();
          } else {
            updateRoleView();
          }
        }
      });
      // Vote button
      document.getElementById('vote-button').addEventListener('click', () => {
        SFX.click();
        showVotePage();
      });
      document.getElementById('show-result-btn').addEventListener('click', () => {
        SFX.click();
        computeResult();
      });
      document.getElementById('back-to-menu').addEventListener('click', () => {
        SFX.click();
        showPage('main-menu');
      });
    }

    function openSettings() {
      document.getElementById('language-select').value = state.language;
      document.getElementById('primary-color').value = state.primary;
      document.getElementById('secondary-color').value = state.secondary;
      document.getElementById('sound-toggle').classList.toggle('on', state.sound);
      document.getElementById('vibration-toggle').classList.toggle('on', state.vibration);
      showPage('settings-page');
    }

    function updateRoleView() {
      const front = document.getElementById('role-front');
      front.textContent = i18n[state.language].tapReveal;
      const back = document.getElementById('role-back');
      back.textContent = '';
      const card = document.getElementById('role-card');
      card.classList.remove('spy-theme','citizen-theme','spy-shake');
      document.getElementById('reveal-title').textContent = i18n[state.language].revealTitle + ' ' + (state.currentPlayerIndex + 1) + '/' + state.playerCount;
    }

    /* Timer functions */
    function startTimer() {
      showPage('timer-page');
      const totalSeconds = state.roundTime * 60;
      let elapsed = 0;
      let warned30 = false;
      const ring = document.getElementById('timer-ring');
      const circumference = 2 * Math.PI * 45;
      ring.style.strokeDasharray = circumference;
      ring.style.strokeDashoffset = '0';
      const updateColor = (secRemaining) => {
        if (secRemaining <= 10) {
          ring.style.stroke = 'red';
        } else if (secRemaining <= 30) {
          ring.style.stroke = 'orange';
        } else {
          ring.style.stroke = state.secondary;
        }
      };
      updateColor(totalSeconds);
      state.timerInterval = setInterval(() => {
        elapsed++;
        const remaining = totalSeconds - elapsed;
        const offset = circumference * (elapsed / totalSeconds);
        ring.style.strokeDashoffset = offset;
        updateColor(remaining);
        if (!warned30 && remaining <= 30 && remaining > 10) {
          warned30 = true;
          SFX.warn();
        }
        if (remaining <= 10 && remaining > 0) {
          SFX.tick();
          if (state.vibration && navigator.vibrate) navigator.vibrate(18);
        }
        if (remaining <= 0) {
          clearInterval(state.timerInterval);
          showVotePage();
        }
      }, 1000);
      // show vote button after timer ends; we also allow manual early vote by pressing the button (makes interactive)
      setTimeout(() => {
        document.getElementById('vote-button').classList.add('show');
      }, 500);
    }

    function showVotePage() {
      clearInterval(state.timerInterval);
      document.getElementById('vote-button').classList.remove('show');
      showPage('vote-page');
      // Build voting list
      const list = document.getElementById('vote-list');
      list.innerHTML = '';
      state.votes = {};
      for (let i = 0; i < state.playerCount; i++) {
        const card = document.createElement('div');
        card.className = 'vote-card glass';
        card.textContent = (state.language === 'fa' ? 'بازیکن ' : 'Player ') + (i + 1);
        card.addEventListener('click', () => {
          const pid = i;
          if (state.votes[pid]) {
            delete state.votes[pid];
            card.classList.remove('selected');
          } else {
            state.votes[pid] = true;
            card.classList.add('selected');
          }
        });
        list.appendChild(card);
      }
      document.getElementById('vote-title').textContent = i18n[state.language].voteInstructions;
    }

    function computeResult() {
      const selected = Object.keys(state.votes).map(Number);
      let spiesCaught = 0;
      for (const idx of selected) {
        if (state.roles[idx].isSpy) spiesCaught++;
      }
      let resultMsg;
      if (spiesCaught >= state.spyCount) {
        resultMsg = i18n[state.language].citizensWin;
      } else if (spiesCaught >= state.spyCount / 2) {
        resultMsg = i18n[state.language].draw;
      } else {
        resultMsg = i18n[state.language].spiesWin;
      }
      document.getElementById('result-message').textContent = resultMsg;
      showPage('result-page');
    }

    /* Init function */
    function init() {
      updateTheme();
      updateLanguage();
      // init slider UI defaults + constraint
      setupUI.pc = document.getElementById('player-count');
      setupUI.sc = document.getElementById('spy-count');
      setupUI.rt = document.getElementById('round-time');
      setupUI.rd = document.getElementById('rounds');
      setupUI.pcV = document.getElementById('player-count-val');
      setupUI.scV = document.getElementById('spy-count-val');
      setupUI.rtV = document.getElementById('round-time-val');
      setupUI.rdV = document.getElementById('rounds-val');
      syncSetupUI();
      initEventHandlers();
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
